

<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>Database Setup: Long Version &mdash; Packaginator v1.0 documentation</title>
    <link rel="stylesheet" href="_static/default.css" type="text/css" />
    <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '',
        VERSION:     '1.0',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="_static/jquery.js"></script>
    <script type="text/javascript" src="_static/underscore.js"></script>
    <script type="text/javascript" src="_static/doctools.js"></script>
    <link rel="top" title="Packaginator v1.0 documentation" href="index.html" /> 
  </head>
  <body>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li><a href="index.html">Packaginator v1.0 documentation</a> &raquo;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body">
            
  <div class="section" id="database-setup-long-version">
<h1>Database Setup: Long Version<a class="headerlink" href="#database-setup-long-version" title="Permalink to this headline">¶</a></h1>
<div class="section" id="dump-the-data-from-the-sqlite3">
<h2>Dump the data from the SQLite3<a class="headerlink" href="#dump-the-data-from-the-sqlite3" title="Permalink to this headline">¶</a></h2>
<p>Run this command to dump the data:</p>
<div class="highlight-python"><pre>$ python manage.py dumpdata --traceback --indent=4 --database=sqlite --natural auth.User auth.Group about grid homepage package searchv1 apiv1 feeds admin sites messages flatpages notification staticfiles mailer uni_form django_openid ajax_validation timezones emailconfirmation announcements pagination idios django_sorting flatblocks account signup_codes analytics south &gt; fixtures/dump_clean_data.json</pre>
</div>
<p>Note that we had to use auth.User and auth.Group because just using auth causes the auth.Permissions to be exported which causes problems (see below). We also don&#8217;t need to export contenttypes because they are created when we do a syncdb.</p>
<p>We also had to exclude profiles because they are created by Pinax in a post.save hook. See the explanation below. These will have to be manually imported.</p>
<p>not included:</p>
<blockquote>
<div><ul class="simple">
<li>template_tags</li>
<li>humanize</li>
<li>django_extensions</li>
<li>south</li>
<li>tastypie</li>
<li>profiles</li>
</ul>
</div></blockquote>
</div>
<div class="section" id="install-postgres-on-your-machine">
<h2>Install Postgres on your machine<a class="headerlink" href="#install-postgres-on-your-machine" title="Permalink to this headline">¶</a></h2>
<p>If you&#8217;re on Ubuntu/Debian Linux, you run this command:</p>
<div class="highlight-python"><pre>$ apt-get install postgres</pre>
</div>
</div>
<div class="section" id="create-a-local-postgres-database">
<h2>Create a local Postgres database<a class="headerlink" href="#create-a-local-postgres-database" title="Permalink to this headline">¶</a></h2>
<p>As user postgres:</p>
<div class="highlight-python"><pre>$ su - postgres
$ createuser --no-createdb --no-createrole --no-superuser packaginator
$ psql template1 -c "ALTER USER packaginator with encrypted password 'packaginator'";
ALTER ROLE
$ createdb packaginator --owner=packaginator --encoding=UTF8</pre>
</div>
</div>
<div class="section" id="edit-the-local-settings-py">
<h2>Edit the local_settings.py<a class="headerlink" href="#edit-the-local-settings-py" title="Permalink to this headline">¶</a></h2>
<p>Switch from using SQLite to PostgreSQL:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">DATABASES</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s">&quot;default&quot;</span><span class="p">:</span> <span class="p">{</span>
        <span class="s">&quot;ENGINE&quot;</span><span class="p">:</span> <span class="s">&quot;postgresql_psycopg2&quot;</span><span class="p">,</span> <span class="c"># Add &quot;postgresql_psycopg2&quot;, &quot;postgresql&quot;, &quot;mysql&quot;, &quot;sqlite3&quot; or &quot;oracle&quot;.</span>
        <span class="s">&quot;NAME&quot;</span><span class="p">:</span> <span class="s">&quot;packaginator&quot;</span><span class="p">,</span>                       <span class="c"># Or path to database file if using sqlite3.</span>
        <span class="s">&quot;USER&quot;</span><span class="p">:</span> <span class="s">&quot;packaginator&quot;</span><span class="p">,</span>                             <span class="c"># Not used with sqlite3.</span>
        <span class="s">&quot;PASSWORD&quot;</span><span class="p">:</span> <span class="s">&quot;packaginator&quot;</span><span class="p">,</span>                         <span class="c"># Not used with sqlite3.</span>
        <span class="s">&quot;HOST&quot;</span><span class="p">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span>                             <span class="c"># Set to empty string for localhost. Not used with sqlite3.</span>
        <span class="s">&quot;PORT&quot;</span><span class="p">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span>                             <span class="c"># Set to empty string for default. Not used with sqlite3.</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Or just use local_settings.py (copy from local_settings.py.example), and pass the parameter &#8211;database=postgres to the manage.py command:</p>
<div class="highlight-python"><pre>$ python manage.py --database=postgres</pre>
</div>
</div>
<div class="section" id="load-the-data-into-the-postgres-database">
<h2>Load the data into the Postgres database<a class="headerlink" href="#load-the-data-into-the-postgres-database" title="Permalink to this headline">¶</a></h2>
<p>Clean out the Postgres database:</p>
<div class="highlight-python"><pre>$ psql -U postgres -c "DROP DATABASE packaginator;"
$ psql -U postgres -c "CREATE DATABASE packaginator OWNER packaginator;"</pre>
</div>
<p>Prep the database for the import:</p>
<div class="highlight-python"><pre>$ python manage.py syncdb
$ python manage.py migrate</pre>
</div>
<p>Now with the fixtures that you made before, try importing this into the Postgres database:</p>
<div class="highlight-python"><pre>$ python manage.py loaddata fixtures/dump_clean_data.json
Installing json fixture 'fixtures/dump_clean_data' from absolute path.
Installed 40540 object(s) from 1 fixture(s)</pre>
</div>
<p>Dump out the Postgres database:</p>
<div class="highlight-python"><pre>$ pg_dump -fC djangopkgs_dump.sql -U postgres packaginator</pre>
</div>
<p>the -C flag tells pg_dump to compress the file. If you don&#8217;t compress it, you need to import it with psql:</p>
<div class="highlight-python"><pre>$ psql packaginator &lt; djangopkgs_dump.sql</pre>
</div>
<p>If you use the -C flag, then you can re-load the data into a new PostgreSQL database with the same name:</p>
<div class="highlight-python"><pre>$ pg_restore -C -d postgres djangopkgs_dump.sql</pre>
</div>
<p>Or to re-load the data into a new PostgreSQL database with a new name:</p>
<div class="highlight-python"><pre>$ createdb -T template0 newdb
$ pg_restore -d newdb djangopkgs_dump.sql</pre>
</div>
<p>See more at this <a class="reference external" href="http://www.postgresql.org/docs/8.4/static/app-pgrestore.html">link</a></p>
</div>
<div class="section" id="integrityerror-duplicate-key-value-violates-unique-constraint-package-package-repo-url-uniq">
<h2>IntegrityError: duplicate key value violates unique constraint &#8220;package_package_repo_url_uniq&#8221;<a class="headerlink" href="#integrityerror-duplicate-key-value-violates-unique-constraint-package-package-repo-url-uniq" title="Permalink to this headline">¶</a></h2>
<p>Start the dbshell and remove the duplicate record:</p>
<div class="highlight-python"><pre>$ python manage.py dbshell
sqlite&gt; .headers ON
sqlite&gt; .tables
...
sqlite&gt; select * from package_package where repo_url='https://github.com/praekelt/praekelt.recipe.deploy';
last_modified_by_id|pypi_home_page|created|participants|title|repo_watchers|repo_commits|pypi_url|pypi_downloads|repo_url|modified|id|created_by_id|category_id|repo_forks|slug|repo_description
||2011-01-13 08:13:30.239496|praekelt,shaunsephton|praekelt.recipe.deploy|3|0|http://pypi.python.org/pypi/praekelt.recipe.deploy|510|https://github.com/praekelt/praekelt.recipe.deploy|2011-03-14 17:34:56.461810|568||4|1|praekelt-recipe-deploy|Buildout recipe making versioned remote deploys trivial.
||2011-02-13 06:46:52.100046|praekelt,shaunsephton|praekelt.recipe.deploy|3|0|http://pypi.python.org/pypi/praekelt.recipe.deploy|510|https://github.com/praekelt/praekelt.recipe.deploy|2011-03-14 17:34:59.806729|635||4|1|praekeltrecipedeploy|Buildout recipe making versioned remote deploys trivial.

# remove one of the packages that have the same repo_url
sqlite&gt; delete from package_package where id=568;
# we haven't actually tried this method. just tried deleting from Django admin
sqlite&gt; delete from package_versions where package_id=568;
sqlite&gt; delete from package_commits where package_id=568;</pre>
</div>
<p>From Django admin:</p>
<p><a class="reference external" href="http://localhost:8000/admin/package/package/568/">http://localhost:8000/admin/package/package/568/</a></p>
<p>click the &#8220;Delete&#8221; button
and click &#8220;Yes, I&#8217;m sure&#8221; button</p>
</div>
<div class="section" id="integrityerror-null-value-in-column-license-violates-not-null-constraint">
<h2>IntegrityError: null value in column &#8220;license&#8221; violates not-null constraint<a class="headerlink" href="#integrityerror-null-value-in-column-license-violates-not-null-constraint" title="Permalink to this headline">¶</a></h2>
<p>Fix the records that have a null value for license:</p>
<div class="highlight-python"><pre>$ python manage.py dbshell
sqlite&gt; .headers ON
sqlite&gt; .tables
...
sqlite&gt; select * from package_package where repo_url='https://github.com/praekelt/praekelt.recipe.deploy';
sqlite&gt; select * from package_version where license is NULL;
license|created|downloads|modified|number|package_id|hidden|id
|2010-11-29 01:32:24.073232|215|2011-03-14 17:11:04.238970|0.1.9|508|0|1697
|2010-11-29 01:32:24.177861|151|2011-03-14 17:11:04.246934|0.1.8|508|1|1698
|2010-11-29 01:36:22.712447|263|2011-03-14 17:16:32.772643|0.1.1|488|0|1708
|2011-01-29 01:15:13.859284|143|2011-03-14 17:19:09.906800|0.1.1|157|1|2062
|2011-01-31 03:25:09.044282|3385|2011-03-14 17:31:32.403084|0.1.2|610|1|2082
|2011-01-31 03:25:09.216632|237|2011-03-14 17:31:32.537941|0.1.0|610|1|2084
|2011-02-03 06:15:29.176789|189|2011-03-14 17:19:09.804499|0.1.2|157|0|2126
sqlite&gt; update package_version set license='' where license is NULL;</pre>
</div>
<p>$ grep &#8216;&#8220;repo_url&#8221;:&#8217; fixtures.json | sort | uniq -d
praekelt.recipe.deploy repo_url appears in both of these package records:
635
568</p>
</div>
<div class="section" id="databaseerror-value-too-long-for-type-character-varying-100">
<h2>DatabaseError: value too long for type character varying(100)<a class="headerlink" href="#databaseerror-value-too-long-for-type-character-varying-100" title="Permalink to this headline">¶</a></h2>
<p>Look at the PostgreSQL log to see what is the offending record:</p>
<blockquote>
<div>$ tail -n 1000 /var/log/postgresql-8.4-main.log
2011-03-16 13:51:34 EDT ERROR:  value too long for type character varying(100)
2011-03-16 13:51:34 EDT STATEMENT:  INSERT INTO &#8220;package_version&#8221; (&#8220;id&#8221;, &#8220;created&#8221;,
&#8220;modified&#8221;, &#8220;package_id&#8221;, &#8220;number&#8221;, &#8220;downloads&#8221;, &#8220;license&#8221;, &#8220;hidden&#8221;) VALUES (1275,
E&#8216;2010-09-27 13:08:13&#8217;, E&#8216;2011-03-14 17:17:49&#8217;, 408, E&#8216;1.1&#8217;, 394, E&#8217;Copyright (c) 20
06, Atamert Ölçgen (<a class="reference external" href="http://www.muhuk.com">http://www.muhuk.com</a>)</div></blockquote>
<p>Edit the .json fixtures file to use the link to the license instead of the full-text:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="p">{</span>
    <span class="s">&quot;pk&quot;</span><span class="p">:</span> <span class="mi">1275</span><span class="p">,</span>
    <span class="s">&quot;model&quot;</span><span class="p">:</span> <span class="s">&quot;package.version&quot;</span><span class="p">,</span>
    <span class="s">&quot;fields&quot;</span><span class="p">:</span> <span class="p">{</span>
        <span class="s">&quot;license&quot;</span><span class="p">:</span> <span class="s">&quot;https://github.com/muhuk/django-formfieldset/raw/master/LICENSE.txt&quot;</span><span class="p">,</span>
        <span class="s">&quot;package&quot;</span><span class="p">:</span> <span class="mi">408</span><span class="p">,</span>
        <span class="s">&quot;downloads&quot;</span><span class="p">:</span> <span class="mi">394</span><span class="p">,</span>
        <span class="s">&quot;created&quot;</span><span class="p">:</span> <span class="s">&quot;2010-09-27 13:08:13&quot;</span><span class="p">,</span>
        <span class="s">&quot;number&quot;</span><span class="p">:</span> <span class="s">&quot;1.1&quot;</span><span class="p">,</span>
        <span class="s">&quot;modified&quot;</span><span class="p">:</span> <span class="s">&quot;2011-03-14 17:17:49&quot;</span><span class="p">,</span>
        <span class="s">&quot;hidden&quot;</span><span class="p">:</span> <span class="n">false</span>
    <span class="p">}</span>
<span class="p">},</span>
</pre></div>
</div>
<p>Notice that there are some unicode strings that may be causing problems: &#8220;Ölçgen&#8221;</p>
<p>This means that we need to set the database encoding to utf-8:</p>
<p>From the <a class="reference external" href="http://www.postgresql.org/docs/8.4/static/app-createdb.html">Createdb</a> docs.</p>
</div>
<div class="section" id="integrityerror-duplicate-key-value-violates-unique-constraint-auth-permission-content-type-id-key">
<h2>IntegrityError: duplicate key value violates unique constraint &#8220;auth_permission_content_type_id_key&#8221;<a class="headerlink" href="#integrityerror-duplicate-key-value-violates-unique-constraint-auth-permission-content-type-id-key" title="Permalink to this headline">¶</a></h2>
<p>You need to export only auth.User and auth.Group but not auth.Permissions.</p>
</div>
<div class="section" id="doesnotexist-contenttype-matching-query-does-not-exist">
<h2>DoesNotExist: ContentType matching query does not exist.<a class="headerlink" href="#doesnotexist-contenttype-matching-query-does-not-exist" title="Permalink to this headline">¶</a></h2>
<p>Delete the content type that exists in sqlite but not PostgreSQL:</p>
<div class="highlight-python"><pre>$ python manage.py shell
&gt;&gt;&gt; from django.contrib.contenttypes.models import ContentType
&gt;&gt;&gt; lsqlite = ContentType.objects.using('sqlite').all()
&gt;&gt;&gt; ct = ContentType.objects.using('sqlite').get(app_label='package', model='repo')
&gt;&gt;&gt; ct
&lt;ContentType: repo&gt;
&gt;&gt;&gt; ct.delete()</pre>
</div>
</div>
<div class="section" id="integrityerror-duplicate-key-value-violates-unique-constraint-account-account-user-id-key">
<h2>IntegrityError: duplicate key value violates unique constraint &#8220;account_account_user_id_key&#8221;<a class="headerlink" href="#integrityerror-duplicate-key-value-violates-unique-constraint-account-account-user-id-key" title="Permalink to this headline">¶</a></h2>
<p>In pinax/apps/account/models.py:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="k">def</span> <span class="nf">create_account</span><span class="p">(</span><span class="n">sender</span><span class="p">,</span> <span class="n">instance</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">instance</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="k">return</span>
    <span class="n">account</span><span class="p">,</span> <span class="n">created</span> <span class="o">=</span> <span class="n">Account</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get_or_create</span><span class="p">(</span><span class="n">user</span><span class="o">=</span><span class="n">instance</span><span class="p">)</span>
</pre></div>
</div>
<p>Comment out the following line:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="c">#post_save.connect(create_account, sender=User)</span>
</pre></div>
</div>
<p>And in idios/models.py:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="k">def</span> <span class="nf">create_profile</span><span class="p">(</span><span class="n">sender</span><span class="p">,</span> <span class="n">instance</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">instance</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="k">return</span>
    <span class="n">profile</span><span class="p">,</span> <span class="n">created</span> <span class="o">=</span> <span class="n">get_profile_model</span><span class="p">()</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get_or_create</span><span class="p">(</span><span class="n">user</span><span class="o">=</span><span class="n">instance</span><span class="p">)</span>
</pre></div>
</div>
<p>Comment out the following line:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="c">#post_save.connect(create_profile, sender=User)</span>
</pre></div>
</div>
</div>
<div class="section" id="integrityerror-duplicate-key-value-violates-unique-constraint-django-content-type-app-label-key">
<h2>IntegrityError: duplicate key value violates unique constraint django_content_type_app_label_key<a class="headerlink" href="#integrityerror-duplicate-key-value-violates-unique-constraint-django-content-type-app-label-key" title="Permalink to this headline">¶</a></h2>
<p>According to this
<a class="reference external" href="http://stackoverflow.com/questions/2323515/how-to-completely-dump-the-data-for-django-cms">StackOverflow discussion</a>, you need to run these commands:</p>
<div class="highlight-python"><pre>$ psql -U postgres packaginator

packaginator=# delete from auth_group_permissions;
packaginator=# delete from auth_permission;
packaginator=# delete from django_admin_log;
packaginator=# delete from reversion_version;
packaginator=# delete from reversion_version;
DELETE 1
packaginator=# delete from django_content_type;
DELETE 47</pre>
</div>
<p>See all the encoding types here:
<a class="reference external" href="http://www.postgresql.org/docs/8.4/static/multibyte.html#MULTIBYTE-CHARSET-SUPPORTED">http://www.postgresql.org/docs/8.4/static/multibyte.html#MULTIBYTE-CHARSET-SUPPORTED</a></p>
<p>/site_media/static/ /media/
/site_media/static/pinax/ {SITE_PACKAGES}/pinax/media/default/pinax/
/site_media/static/uni_form/ {SITE_PACKAGES}/uni_form/media/uni_form/</p>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="sphinxsidebar">
        <div class="sphinxsidebarwrapper">
  <h3><a href="index.html">Table Of Contents</a></h3>
  <ul>
<li><a class="reference internal" href="#">Database Setup: Long Version</a><ul>
<li><a class="reference internal" href="#dump-the-data-from-the-sqlite3">Dump the data from the SQLite3</a></li>
<li><a class="reference internal" href="#install-postgres-on-your-machine">Install Postgres on your machine</a></li>
<li><a class="reference internal" href="#create-a-local-postgres-database">Create a local Postgres database</a></li>
<li><a class="reference internal" href="#edit-the-local-settings-py">Edit the local_settings.py</a></li>
<li><a class="reference internal" href="#load-the-data-into-the-postgres-database">Load the data into the Postgres database</a></li>
<li><a class="reference internal" href="#integrityerror-duplicate-key-value-violates-unique-constraint-package-package-repo-url-uniq">IntegrityError: duplicate key value violates unique constraint &#8220;package_package_repo_url_uniq&#8221;</a></li>
<li><a class="reference internal" href="#integrityerror-null-value-in-column-license-violates-not-null-constraint">IntegrityError: null value in column &#8220;license&#8221; violates not-null constraint</a></li>
<li><a class="reference internal" href="#databaseerror-value-too-long-for-type-character-varying-100">DatabaseError: value too long for type character varying(100)</a></li>
<li><a class="reference internal" href="#integrityerror-duplicate-key-value-violates-unique-constraint-auth-permission-content-type-id-key">IntegrityError: duplicate key value violates unique constraint &#8220;auth_permission_content_type_id_key&#8221;</a></li>
<li><a class="reference internal" href="#doesnotexist-contenttype-matching-query-does-not-exist">DoesNotExist: ContentType matching query does not exist.</a></li>
<li><a class="reference internal" href="#integrityerror-duplicate-key-value-violates-unique-constraint-account-account-user-id-key">IntegrityError: duplicate key value violates unique constraint &#8220;account_account_user_id_key&#8221;</a></li>
<li><a class="reference internal" href="#integrityerror-duplicate-key-value-violates-unique-constraint-django-content-type-app-label-key">IntegrityError: duplicate key value violates unique constraint django_content_type_app_label_key</a></li>
</ul>
</li>
</ul>

  <h3>This Page</h3>
  <ul class="this-page-menu">
    <li><a href="_sources/db_long_version.txt"
           rel="nofollow">Show Source</a></li>
  </ul>
<div id="searchbox" style="display: none">
  <h3>Quick search</h3>
    <form class="search" action="search.html" method="get">
      <input type="text" name="q" size="18" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Enter search terms or a module, class or function name.
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li><a href="index.html">Packaginator v1.0 documentation</a> &raquo;</li> 
      </ul>
    </div>
    <div class="footer">
        &copy; Copyright 2011, Audrey Roy, Daniel Greenfeld and contributors.
      Created using <a href="http://sphinx.pocoo.org/">Sphinx</a> 1.0.7.
    </div>
  </body>
</html>